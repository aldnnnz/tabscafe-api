generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}


enum RoastType {
  LIGHT
  LIGHT_MEDIUM
  MEDIUM
  MEDIUM_DARK
  DARK
}

enum OrderStatus {
  DRAFT
  PENDING_PAYMENT
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  FAILED
  ON_HOLD
}

enum PaymentMethod {
  BANK_TRANSFER_BCA
  BANK_TRANSFER_MANDIRI
  BANK_TRANSFER_BNI
  BANK_TRANSFER_BRI
  BANK_TRANSFER_PERMATA
  BANK_TRANSFER_OTHER
  CREDIT_CARD
  GOPAY
  SHOPEEPAY
  QRIS
  ALFAMART
  INDOMARET
  AKULAKU
  KREDIVO
  COD
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURE
  SETTLEMENT
  DENY
  CANCEL
  EXPIRE
  REFUND
  PARTIAL_REFUND
  FAILURE
  CHALLENGE
}

enum PaymentGateway {
  MIDTRANS
  MANUAL
}

enum UserRole {
  ADMIN
  CUSTOMER
}

model User {
  id                 String     @id @default(uuid())
  name               String     @db.VarChar(100)
  email              String     @unique @db.VarChar(255)
  password           String     @db.VarChar(255)
  role               UserRole   @default(CUSTOMER)
  phone              String?    @db.VarChar(20)
  address            String?    @db.Text
  emailVerified      Boolean    @default(false)
  emailVerifyToken   String?
  emailVerifyExpires DateTime?
  isActive           Boolean    @default(true)
  deletedAt          DateTime?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  orders             Order[]
  cart               Cart?
  reviews            Review[]
  wishlist           WishlistItem[]
  notifications      Notification[]
  recentlyViewed     RecentlyViewedProduct[]

  @@index([email])
  @@index([isActive])
  @@index([createdAt])
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(100)
  slug        String    @unique @db.VarChar(100)
  description String?
  image       String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@index([slug])
  @@index([isActive])
  @@index([sortOrder])
}

model Product {
  id              Int        @id @default(autoincrement())
  name            String     @db.VarChar(200)
  slug            String     @unique @db.VarChar(200)
  description     String?
  notes           String?
  origin          String?
  badge           String?
  images          Json
  price           Int        @default(0)
  discountPrice   Int?
  isOnSale        Boolean    @default(false)
  isAvailable     Boolean    @default(true)
  roast           RoastType
  weight          Int?
  stock           Int        @default(0)
  reservedStock   Int        @default(0)
  sku             String?    @unique
  barcode         String?
  metaTitle       String?
  metaDescription String?
  averageRating   Float      @default(0)
  reviewCount     Int        @default(0)
  soldCount       Int        @default(0)
  viewCount       Int        @default(0)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  categoryId      Int
  category        Category   @relation(fields: [categoryId], references: [id])

  reviews         Review[]
  orderItems      OrderItem[]
  cartItems       CartItem[]
  wishlistItems   WishlistItem[]
  recentlyViewed  RecentlyViewedProduct[]

  @@index([categoryId])
  @@index([price])
  @@index([isAvailable])
  @@index([isOnSale])
  @@index([stock])
  @@index([createdAt])
}


model Order {
  id                    Int             @id @default(autoincrement())
  orderCode             String          @unique
  totalPrice            Int
  shippingCost          Int             @default(0)
  grandTotal            Int
  status                OrderStatus     @default(DRAFT)

  paymentGateway        PaymentGateway  @default(MIDTRANS)
  paymentMethod         PaymentMethod?
  paymentStatus         PaymentStatus   @default(PENDING)

  midtransOrderId       String?         @unique
  midtransTransactionId String?

  paymentToken          String?
  paymentRedirectUrl    String?
  vaNumber              String?
  bank                  String?
  eWalletType           String?
  qrCodeUrl             String?
  storeCode             String?
  paymentCode           String?

  paymentProofImage     String?

  customerName          String
  customerEmail         String
  customerPhone         String
  shippingAddress       String
  shippingNotes         String?

  paymentExpiry         DateTime?
  settlementTime        DateTime?
  paidAt                DateTime?
  processingAt          DateTime?
  shippedAt             DateTime?
  deliveredAt           DateTime?
  cancelledAt           DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  fraudStatus           String?
  paymentMetadata       Json?
  adminNotes            String?

  userId                String?
  user                  User?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  orderItems            OrderItem[]
  paymentLogs           PaymentLog[]
  refunds               Refund[]
  reviews               Review[]
  notifications         Notification[]

  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
}

model OrderItem {
  id            Int       @id @default(autoincrement())
  quantity      Int
  price         Int
  discountPrice Int?
  subtotal      Int
  productName   String
  productImage  String?
  productWeight Int?
  createdAt     DateTime  @default(now())

  orderId       Int
  productId     Int

  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product   @relation(fields: [productId], references: [id])

  @@unique([orderId, productId])
  @@index([orderId])
  @@index([productId])
  @@index([createdAt])
}

model Cart {
  id        Int       @id @default(autoincrement())
  total     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  userId    String    @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  items     CartItem[]
}

model CartItem {
  id        Int       @id @default(autoincrement())
  quantity  Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  cartId    Int
  productId Int

  cart      Cart      @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
}

model Review {
  id          Int       @id @default(autoincrement())
  rating      Int
  comment     String?
  images      Json?
  isHelpful   Int       @default(0)
  isVerified  Boolean   @default(false)
  isApproved  Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  userId      String
  productId   Int
  orderId     Int?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id])
  order       Order?    @relation(fields: [orderId], references: [id])

  @@unique([userId, productId, orderId])
  @@index([productId])
  @@index([rating])
  @@index([isApproved])
}


model WishlistItem {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())

  userId    String
  productId Int

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
}


model RecentlyViewedProduct {
  id        Int       @id @default(autoincrement())
  userId    String
  productId Int
  createdAt DateTime  @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
  @@index([createdAt])
}


model PaymentLog {
  id                    Int           @id @default(autoincrement())
  orderId               Int
  orderCode             String

  oldStatus             PaymentStatus?
  newStatus             PaymentStatus
  statusMessage         String?

  midtransOrderId       String?
  midtransTransactionId String?

  notificationType      String?
  signatureKey          String?
  transactionTime       DateTime?

  rawData               Json?
  ipAddress             String?
  userAgent             String?
  processedBy           String?
  processedAt           DateTime?

  createdAt             DateTime      @default(now())

  order                 Order         @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([midtransOrderId])
  @@index([newStatus])
}


model Refund {
  id                Int       @id @default(autoincrement())
  orderId           Int
  refundAmount      Int
  refundReason      String?
  status            String

  midtransRefundKey String?   @unique
  refundId          String?

  notes             String?
  processedBy       String?
  processedAt       DateTime?
  completedAt       DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  order             Order     @relation(fields: [orderId], references: [id])
}


model Notification {
  id          Int       @id @default(autoincrement())
  type        String
  title       String
  message     String
  isRead      Boolean   @default(false)
  metadata    Json?
  scheduledAt DateTime?
  sentAt      DateTime?
  createdAt   DateTime  @default(now())

  userId      String
  orderId     Int?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  order       Order?    @relation(fields: [orderId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([sentAt])
}
